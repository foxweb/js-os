###############################################################################
#                                                                             #
#     IAR Systems Z80/64180 Assembler V4.06A/W32 02/Apr/2012  11:39:02        #
#     Copyright 2001 IAR Systems. All rights reserved.                        #
#                                                                             #
#           Target option =  z80                                              #
#           Source file   =  js-os.asm                                        #
#           List file     =  js-os.lst                                        #
#           Object file   =  js-os.r01                                        #
#           Command line  =  js-os.asm -l js-os.lst                           #
#                                                                             #
###############################################################################

      1    005B00          ; ------- external modules
      2    000000          extern    font8
      3    005B00          #include "conf.asm"
      4    005B00          #include "macro.asm"
      5    005B00          #include "vars.asm"
      6    004420          
      7    004420          
      8    004420          ; ------- main code
      9    000000                          rseg CODE
     10    000000          
     11    000000 F3                       di
     12    000001 C3....                   jp START
     13    000004          
     14    000080                          org h'80        ; Decimal 128
     15    000080          START
     16    000080 0611                     ld b,h'11
     17    000082 1605                     ld d, h'5
     18    000084 CD....                   call set_ram_pager
     19    000087 310060                   ld sp, stck
     20    00008A 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
     21    00008C 32015B                   ld (current_pen),a
     22    00008F 110000                   LD DE,h'0000            ; Set XYPOS
                                                                    D - Y , E -
                                                                    X to the
                                                                    default of
                                                                    0,0
     23    000092 ED53035B                 LD (cursor_y),DE
     24    000096 CD....                   call load_font
     25    000099 AF                       xor a
     26    00009A D3FE                     out (254), a
     27    00009C 0612                     ld b,h'12
     28    00009E 1602                     ld d, h'2
     29    0000A0 CD....                   call set_ram_pager
     30    0000A3 CD....                   call LD_64_PAL          ; Load
                                                                    default 64
                                                                    colour
                                                                    palette
     31    0000A6 2103C0                   ld hl, h'c003           ; Hopefully
                                                                    set 360x288
                                                                    text
                                                                    ?
     32    0000A9 CD....                   call set_video_mode
     33    0000AC 0613                     ld b,h'13
     34    0000AE 16F8                     ld d, txpage
     35    0000B0 CD....                   call set_ram_pager
     36    0000B3 CD....                   call cls_text
     37    0000B6 3E00                     ld a, h'0
     38    0000B8 32025B                   ld (border_colour), a
     39    0000BB CD....                   call set_border
     40    0000BE                          
     41    0000BE           ; Setup system variables
     42    0000BE          
     43    0000BE 3E01                     ld a, 1
     44    0000C0 32085B                   ld (cursorstatus), a
     45    0000C3 3E64                     ld a, 100
     46    0000C5 32075B                   ld (cursorflashtimer), a
     47    0000C8 3E0F                     ld a, h'0f
     48    0000CA 32015B                   ld (current_pen), a
     49    0000CD          
     50    0000CD                          ;-----------------------------------
                           -----------------------------------
     51    0000CD                          ;PS2 initialization:
     52    0000CD          
     53    0000CD 01F7EF                   LD BC,h'EFF7
     54    0000D0 3E80                     LD A,h'80
     55    0000D2 ED79                     OUT (C),A
     56    0000D4 01F7DF                   LD BC,h'DFF7
     57    0000D7 3EF0                     LD A,h'F0
     58    0000D9 ED79                     OUT (C),A
     59    0000DB 01F7BF                   LD BC,h'BFF7
     60    0000DE 3E02                     LD A,h'02
     61    0000E0 ED79                     OUT (C),A
     62    0000E2          
     63    0000E2                          ;-----------------------------------
                           -----------------------------------
     64    0000E2                          ;Initialise IM2 interrupts:
     65    0000E2          
     66    0000E2 21....                   LD HL, I_N_T
     67    0000E5 22FF5B                   LD (h'5BFF), HL ; Address for IM2
                                                            mode routine.
     68    0000E8 F3                       DI
     69    0000E9 3E5B                     LD A, h'5B
     70    0000EB ED47                     LD I, A
     71    0000ED ED5E                     IM 2
     72    0000EF          
     73    0000EF                          ;-----------------------------------
                           -----------------------------------
     74    0000EF          
     75    0000EF          ;MAIN CYCLE:
     76    0000EF                    
     77    0000EF                          
     78    0000EF 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
     79    0000F1 32015B                   ld (current_pen),a
     80    0000F4 110000                   ld de, h'0000           ; Set Y=0 ,
                                                                    X=0
     81    0000F7 ED53035B                 ld (cursor_y), de
     82    0000FB 21....                   ld hl , M_HEAD1
     83    0000FE CD....                   call print_msg_c
     84    000101 3E0F                     ld a, h'0f
     85    000103 32015B                   ld (current_pen), a
     86    000106 110001                   ld de, h'0100           ; Set Y=1 ,
                                                                    X=0
     87    000109 ED53035B                 ld (cursor_y), de
     88    00010D 21....                   ld hl , M_HEAD2
     89    000110 CD....                   call print_msg_c
     90    000113                          
     91    000113 110005                   ld de, h'0500                   ; Y
                                                   = 5 , X = 0 setup powerup
                                                   cursor position
     92    000116 ED53035B                 ld (cursor_y), de
     93    00011A                          
     94    00011A                          ;-----------------------------------
                           --------------------
     95    00011A                          ;initialization for inputing
                            string:
     96    00011A          
     97    00011A CD....   MAIN            call get_address
     98    00011D                          ;LD HL, h'c000          ; address on
                            screen (first line)
     99    00011D 110059                   LD DE, h'5900           ;curMAX +
                                                                    curNOW
    100    000120          
    101    000120                          ;curMAX - lenght of editing
                            string
    102    000120                          ;curNOW - cursor starting position
    103    000120          
    104    000120 3EFF                     LD A, h'ff                      ;
                                                  #FF - initialization
    105    000122 CD....                   CALL ISTR
    106    000125                          
    107    000125                          ;-----------------------------------
                           --------------------
    108    000125          
    109    000125                          
    110    000125          
    111    000125                          
    112    000125 FB       MAIN1           ei
    113    000126 76                       halt
    114    000127                          ;if ENTER pressed then exit:
    115    000127 CD....                   CALL ENKE
    116    00012A 2006                     jr nz, enter
    117    00012C          
    118    00012C          ;editing string:
    119    00012C                          
    120    00012C AF                       XOR A; 0 - inputing
    121    00012D CD....                   CALL ISTR
    122    000130 18F3                     JR MAIN1
    123    000132          
    124    000132          enter
    125    000132 ED5B035B                 ld de, (cursor_y)
    126    000136 3E12                     ld a, h'12
    127    000138 BA                       cp d
    128    000139 CA....                   jp z, cls_text
    129    00013C 14                       inc d
    130    00013D ED53035B                 ld (cursor_y), de
    131    000141 3E01                     ld a, 01
    132    000143 CD....                   call ISTR
    133    000146 E5                       push hl                 ; copy HL
                                                                    into
                                                                    DE
    134    000147 D1                       pop de
    135    000148 CD....                   call parse
    136    00014B 18CD                     jr MAIN
    137    00014D                          
    138    00014D          
    139    00014D          ;---------------------------------------------------
                           -------------------
    140    00014D          ; IM2 Interrupt handler:
    141    00014D F5       I_N_T           PUSH AF
    142    00014E C5                       PUSH BC
    143    00014F D5                       PUSH DE
    144    000150 E5                       PUSH HL
    145    000151 DDE5                     PUSH IX
    146    000153 D9                       EXX
    147    000154 08                       EX AF, AF
    148    000155 F5                       PUSH AF
    149    000156 C5                       PUSH BC
    150    000157 D5                       PUSH DE
    151    000158 E5                       PUSH HL
    152    000159          
    153    000159 CD....                   CALL PSDII      ; Get value from PS2
                                                            keyboard buffer.
    154    00015C          
    155    00015C E1                       POP HL
    156    00015D D1                       POP DE
    157    00015E C1                       POP BC
    158    00015F F1                       POP AF
    159    000160 D9                       EXX
    160    000161 08                       EX AF, AF
    161    000162 DDE1                     POP IX
    162    000164 E1                       POP HL
    163    000165 D1                       POP DE
    164    000166 C1                       POP BC
    165    000167 F1                       POP AF
    166    000168 FB                       EI
    167    000169 C9                       RET
    168    00016A          
    169    00016A          ;---------------------------------------------------
                           -------------------
    170    00016A          
    171    00016A          #include "nvram.asm"
    172    0001F8          #include "gfx-routines.asm"
    173    00045F          #include "maths-routines.asm"
    174    00054F          #include "parser.asm"
    175    0005C5          #include "ps2_handler.asm"
    176    00097A          #include "commands/test.asm"
    177    000985          #include "commands/time.asm"
    178    0009BB          #include "commands/date.asm"
    179    0009FB          #include "commands/cls.asm"
    180    000A07          #include "booter.asm"
    181    00110E          #include "arrays.asm"
    182    001442          #include "restarts.asm"
    183    000068          
    184    000068          
    185    000068          
    186    000068                  end
##############################
#          CRC:9CB9          #
#        Errors:   0         #
#        Warnings: 0         #
#        Bytes: 5058         #
##############################



