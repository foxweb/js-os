###############################################################################
#                                                                             #
#     IAR Systems Z80/64180 Assembler V4.06A/W32 30/Mar/2012  18:08:39        #
#     Copyright 2001 IAR Systems. All rights reserved.                        #
#                                                                             #
#           Target option =  z80                                              #
#           Source file   =  js-os.asm                                        #
#           List file     =  js-os.lst                                        #
#           Object file   =  js-os.r01                                        #
#           Command line  =  js-os.asm -l js-os.lst                           #
#                                                                             #
###############################################################################

      1    005B00          ; ------- external modules
      2    000000          extern    font8
      3    005B00          #include "conf.asm"
      4    005B00          #include "macro.asm"
      5    005B00          #include "vars.asm"
      6    004420          
      7    004420          
      8    004420          ; ------- main code
      9    000000                          rseg CODE
     10    000000          
     11    000000 F3                       di
     12    000001 C3....                   jp START
     13    000004          
     14    000080                          org h'80        ; Decimal 128
     15    000080          START
     16    000080 0611                     ld b,h'11
     17    000082 1605                     ld d, h'5
     18    000084 CD....                   call set_ram_pager
     19    000087 310060                   ld sp, stck
     20    00008A 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
     21    00008C 32015B                   ld (current_pen),a
     22    00008F 110000                   LD DE,h'0000            ; Set XYPOS
                                                                    D - Y , E -
                                                                    X to the
                                                                    default of
                                                                    0,0
     23    000092 ED53035B                 LD (cursor_y),DE
     24    000096 CD....                   call load_font
     25    000099 AF                       xor a
     26    00009A D3FE                     out (254), a
     27    00009C 0612                     ld b,h'12
     28    00009E 1602                     ld d, h'2
     29    0000A0 CD....                   call set_ram_pager
     30    0000A3 CD....                   call LD_64_PAL          ; Load
                                                                    default 64
                                                                    colour
                                                                    palette
     31    0000A6 2103C0                   ld hl, h'c003           ; Hopefully
                                                                    set 360x288
                                                                    text
                                                                    ?
     32    0000A9 CD....                   call set_video_mode
     33    0000AC 0613                     ld b,h'13
     34    0000AE 16F8                     ld d, txpage
     35    0000B0 CD....                   call set_ram_pager
     36    0000B3 CD....                   call cls_text
     37    0000B6 3E00                     ld a, h'0
     38    0000B8 32025B                   ld (border_colour), a
     39    0000BB CD....                   call set_border
     40    0000BE                          
     41    0000BE           ; Setup system variables
     42    0000BE          
     43    0000BE 3E01                     ld a, 1
     44    0000C0 32085B                   ld (cursorstatus), a
     45    0000C3 3E64                     ld a, 100
     46    0000C5 32075B                   ld (cursorflashtimer), a
     47    0000C8 110005                   ld de, h'0500                   ; Y
                                                   = 5 , X = 0 setup powerup
                                                   cursor position
     48    0000CB ED53035B                 ld (cursor_y), de
     49    0000CF          
     50    0000CF          
     51    0000CF                          
     52    0000CF CD....    CALL INIT      ; Initialise PS2 keyboard interface.
     53    0000D2          
     54    0000D2          ;Initialise IM2 interrupts:
     55    0000D2 21....   INTA            LD HL, I_N_T
     56    0000D5 22FF5B                   LD (h'5BFF), HL ; Address for IM2
                                                            mode routine.
     57    0000D8 F3                       DI
     58    0000D9 3E5B                     LD A, h'5B
     59    0000DB ED47                     LD I, A
     60    0000DD ED5E                     IM 2
     61    0000DF          
     62    0000DF                          ;-----------------------------------
                           --------------------
     63    0000DF                          ;initialization for inputing
                            string:
     64    0000DF          
     65    0000DF 2100C0                   LD HL, h'C000           ; address on
                                                                    screen
                                                                    (first
                                                                    line)
     66    0000E2 110008                   LD DE, h'0800           ;curMAX +
                                                                    curNOW
     67    0000E5          
     68    0000E5                          ;curMAX - lenght of editing
                            string
     69    0000E5                          ;curNOW - cursor starting position
     70    0000E5          
     71    0000E5 3EFF                     LD A, h'FF                      ;
                                                  #FF - initialization
     72    0000E7 CD....                   CALL ISTR
     73    0000EA                          
     74    0000EA                          ;-----------------------------------
                           --------------------
     75    0000EA          
     76    0000EA C3....                   jp MAIN
     77    0000ED          
     78    0000ED          ;-------------------------------
     79    0000ED          ;PS2 initialization:
     80    0000ED 01F7EF   INIT            LD BC,h'EFF7
     81    0000F0 3E80                     LD A,h'80
     82    0000F2 ED79                     OUT (C),A
     83    0000F4 01F7DF                   LD BC,h'DFF7
     84    0000F7 3EF0                     LD A,h'F0
     85    0000F9 ED79                     OUT (C),A
     86    0000FB 01F7BF                   LD BC,h'BFF7
     87    0000FE 3E02                     LD A,h'02
     88    000100 ED79                     OUT (C),A
     89    000102 C9                       RET
     90    000103          ;-------------------------------
     91    000103          ; IM2 Interrupt handler:
     92    000103 F5       I_N_T           PUSH AF
     93    000104 C5                       PUSH BC
     94    000105 D5                       PUSH DE
     95    000106 E5                       PUSH HL
     96    000107 DDE5                     PUSH IX
     97    000109 D9                       EXX
     98    00010A 08                       EX AF, AF
     99    00010B F5                       PUSH AF
    100    00010C C5                       PUSH BC
    101    00010D D5                       PUSH DE
    102    00010E E5                       PUSH HL
    103    00010F          
    104    00010F CD....                   CALL PSDII      ; Get value from PS2
                                                            keyboard buffer.
    105    000112          
    106    000112 E1                       POP HL
    107    000113 D1                       POP DE
    108    000114 C1                       POP BC
    109    000115 F1                       POP AF
    110    000116 D9                       EXX
    111    000117 08                       EX AF, AF
    112    000118 DDE1                     POP IX
    113    00011A E1                       POP HL
    114    00011B D1                       POP DE
    115    00011C C1                       POP BC
    116    00011D F1                       POP AF
    117    00011E FB                       EI
    118    00011F C9                       RET
    119    000120                          
    120    000120          ;MAIN CYCLE:
    121    000120 FB       MAIN            EI   
    122    000121                          
    123    000121 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
    124    000123 32015B                   ld (current_pen),a
    125    000126 110000                   ld de, h'0000           ; Set Y=0 ,
                                                                    X=0
    126    000129 ED53035B                 ld (cursor_y), de
    127    00012D 21....                   ld hl , M_HEAD1
    128    000130 CD....                   call print_msg_c
    129    000133 3E0F                     ld a, h'0f
    130    000135 32015B                   ld (current_pen), a
    131    000138 110001                   ld de, h'0100           ; Set Y=1 ,
                                                                    X=0
    132    00013B ED53035B                 ld (cursor_y), de
    133    00013F 21....                   ld hl , M_HEAD2
    134    000142 CD....                   call print_msg_c
    135    000145          
    136    000145          
    137    000145 11000A   MAIN1           ld de, h'0A00           ; Set Y=10 ,
                                                                    X=0
    138    000148 ED53035B                 ld (cursor_y), de
    139    00014C                          ;if ENTER pressed then exit:
    140    00014C CD....                   CALL ENKE
    141    00014F 2006                     jr nz, enter
    142    000151          
    143    000151          ;editing string:
    144    000151 AF                       XOR A; 0 - inputing
    145    000152 CD....                   CALL ISTR
    146    000155 18EE                     JR MAIN1
    147    000157          
    148    000157          enter
    149    000157 E5                       push hl                 ; copy HL
                                                                    into
                                                                    DE
    150    000158 D1                       pop de
    151    000159 CD....                   call parse
    152    00015C 18E7                     jr MAIN1
    153    00015E          
    154    00015E          nvramloop       
    155    00015E          
    156    00015E 110008                   ld de, h'0800           ; Set Y=8 ,
                                                                    X=0
    157    000161 ED53035B                 ld (cursor_y), de
    158    000165 21....                   ld hl , M_TIME
    159    000168 CD....                   call os_print_string
    160    00016B 1E04                     ld e, h'04
    161    00016D CD....                   call READ_NVRAM_LOC
    162    000170 3A005D                   ld a, (nv_buf)
    163    000173 CD....                   call BCD_DISP
    164    000176 3E3A                     ld a, ':'
    165    000178 CD....                   call os_plotchar
    166    00017B 1E02                     ld e, h'02
    167    00017D CD....                   call READ_NVRAM_LOC
    168    000180 3A005D                   ld a, (nv_buf)
    169    000183 CD....                   call BCD_DISP
    170    000186 3E3A                     ld a, ':'
    171    000188 CD....                   call os_plotchar
    172    00018B 1E00                     ld e, h'00
    173    00018D CD....                   call READ_NVRAM_LOC
    174    000190 3A005D                   ld a, (nv_buf)
    175    000193 CD....                   call BCD_DISP
    176    000196 C3....                   jp MAIN1
    177    000199                          
    178    000199          
    179    000199          #include "nvram.asm"
    180    000227          #include "gfx-routines.asm"
    181    000476          #include "maths-routines.asm"
    182    000566          #include "parser.asm"
    183    0005DF          #include "ps2_handler.asm"
    184    000994          #include "commands/test.asm"
    185    00099F          #include "commands/time.asm"
    186    0009D5          #include "commands/date.asm"
    187    000A15          #include "commands/cls.asm"
    188    000A21          #include "booter.asm"
    189    001128          #include "arrays.asm"
    190    00145C          #include "restarts.asm"
    191    000068          
    192    000068          
    193    000068          
    194    000068                  end
##############################
#          CRC:906A          #
#        Errors:   0         #
#        Warnings: 0         #
#        Bytes: 5084         #
##############################



