###############################################################################
#                                                                             #
#     IAR Systems Z80/64180 Assembler V4.06A/W32 03/Apr/2012  23:00:38        #
#     Copyright 2001 IAR Systems. All rights reserved.                        #
#                                                                             #
#           Target option =  z80                                              #
#           Source file   =  js-os.asm                                        #
#           List file     =  js-os.lst                                        #
#           Object file   =  js-os.r01                                        #
#           Command line  =  js-os.asm -l js-os.lst                           #
#                                                                             #
###############################################################################

      1    005B00          ; ------- external modules
      2    000000          extern    font8
      3    005B00          #include "conf.asm"
      4    005B00          #include "macro.asm"
      5    005B00          #include "vars.asm"
      6    004420          
      7    004420          
      8    004420          ; ------- main code
      9    000000                          rseg CODE
     10    000000          
     11    000000 F3                       di
     12    000001 C3....                   jp START
     13    000004          
     14    000080                          org h'80        ; Decimal 128
     15    000080          START
     16    000080 0611                     ld b,h'11
     17    000082 1605                     ld d, h'5
     18    000084 CD....                   call set_ram_pager
     19    000087 310060                   ld sp, stck
     20    00008A 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
     21    00008C 32015B                   ld (current_pen),a
     22    00008F 110000                   LD DE,h'0000            ; Set XYPOS
                                                                    D - Y , E -
                                                                    X to the
                                                                    default of
                                                                    0,0
     23    000092 ED53035B                 LD (cursor_y),DE
     24    000096 CD....                   call load_font
     25    000099 AF                       xor a
     26    00009A D3FE                     out (254), a
     27    00009C 0612                     ld b,h'12
     28    00009E 1602                     ld d, h'2
     29    0000A0 CD....                   call set_ram_pager
     30    0000A3 CD....                   call LD_64_PAL          ; Load
                                                                    default 64
                                                                    colour
                                                                    palette
     31    0000A6 2103C0                   ld hl, h'c003           ; Hopefully
                                                                    set 360x288
                                                                    text
                                                                    ?
     32    0000A9 CD....                   call set_video_mode
     33    0000AC 0613                     ld b,h'13
     34    0000AE 16F8                     ld d, txpage
     35    0000B0 CD....                   call set_ram_pager
     36    0000B3 CD....                   call cls_text
     37    0000B6 3E00                     ld a, h'0
     38    0000B8 32025B                   ld (border_colour), a
     39    0000BB CD....                   call set_border
     40    0000BE                          
     41    0000BE           ; Setup system variables
     42    0000BE          
     43    0000BE 3E01                     ld a, 1
     44    0000C0 32085B                   ld (cursorstatus), a
     45    0000C3 3E64                     ld a, 100
     46    0000C5 32075B                   ld (cursorflashtimer), a
     47    0000C8 3E0F                     ld a, h'0f
     48    0000CA 32015B                   ld (current_pen), a
     49    0000CD 3E19                     ld a, 25                        ;
                                                  Auto repeat default
                                                  value
     50    0000CF 320B5B                   ld (key_repeat), a
     51    0000D2          
     52    0000D2                          ;-----------------------------------
                           -----------------------------------
     53    0000D2                          ;PS2 initialization:
     54    0000D2          
     55    0000D2 01F7EF                   LD BC,h'EFF7
     56    0000D5 3E80                     LD A,h'80
     57    0000D7 ED79                     OUT (C),A
     58    0000D9 01F7DF                   LD BC,h'DFF7
     59    0000DC 3EF0                     LD A,h'F0
     60    0000DE ED79                     OUT (C),A
     61    0000E0 01F7BF                   LD BC,h'BFF7
     62    0000E3 3E02                     LD A,h'02
     63    0000E5 ED79                     OUT (C),A
     64    0000E7                          
     65    0000E7 CD....                   CALL AGU; reset win keyz and clear
                                                      KB buffer
     66    0000EA          
     67    0000EA                          ;-----------------------------------
                           -----------------------------------
     68    0000EA                          ;Initialise IM2 interrupts:
     69    0000EA          
     70    0000EA 21....                   LD HL, I_N_T
     71    0000ED 22FF5B                   LD (h'5BFF), HL         ; Address
                                                                    for IM2
                                                                    mode
                                                                    routine.
     72    0000F0 F3                       DI
     73    0000F1 3E5B                     LD A, h'5B
     74    0000F3 ED47                     LD I, A
     75    0000F5 ED5E                     IM 2
     76    0000F7          
     77    0000F7                          ;-----------------------------------
                           -----------------------------------
     78    0000F7          
     79    0000F7          ;MAIN CYCLE:
     80    0000F7                    
     81    0000F7                          
     82    0000F7 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
     83    0000F9 32015B                   ld (current_pen),a
     84    0000FC 110000                   ld de, h'0000           ; Set Y=0 ,
                                                                    X=0
     85    0000FF ED53035B                 ld (cursor_y), de
     86    000103 21....                   ld hl , M_HEAD1
     87    000106 CD....                   call print_msg_c
     88    000109 3E0F                     ld a, h'0f
     89    00010B 32015B                   ld (current_pen), a
     90    00010E 110001                   ld de, h'0100           ; Set Y=1 ,
                                                                    X=0
     91    000111 ED53035B                 ld (cursor_y), de
     92    000115 21....                   ld hl , M_HEAD2
     93    000118 CD....                   call print_msg_c
     94    00011B                          
     95    00011B 110005                   ld de, h'0500                   ; Y
                                                   = 5 , X = 0 setup powerup
                                                   cursor position
     96    00011E ED53035B                 ld (cursor_y), de
     97    000122                          
     98    000122                          ;-----------------------------------
                           --------------------
     99    000122                          ;initialization for inputing
                            string:
    100    000122          
    101    000122 CD....   MAIN            call get_address
    102    000125                          ;LD HL, h'c000          ; address on
                            screen (first line)
    103    000125 110059                   LD DE, h'5900           ;curMAX +
                                                                    curNOW
    104    000128          
    105    000128                          ;curMAX - lenght of editing
                            string
    106    000128                          ;curNOW - cursor starting position
    107    000128          
    108    000128 3EFF                     LD A, h'ff                      ;
                                                  #FF - initialization
    109    00012A CD....                   CALL ISTR
    110    00012D                          
    111    00012D                          ;-----------------------------------
                           --------------------
    112    00012D                          
    113    00012D FB       MAIN1           ei
    114    00012E 76                       halt
    115    00012F                          ;if ENTER pressed then parse:
    116    00012F CD....                   CALL ENKE
    117    000132 2006                     jr nz, enter
    118    000134          
    119    000134          ;editing string:
    120    000134                          
    121    000134 AF                       XOR A                           ; 0
  - inputing
    122    000135 CD....                   CALL ISTR
    123    000138 18F3                     JR MAIN1
    124    00013A          
    125    00013A          enter
    126    00013A ED5B035B                 ld de, (cursor_y)
    127    00013E 14                       inc d
    128    00013F ED53035B                 ld (cursor_y), de
    129    000143 3E01                     ld a, 01                        ;
                                                  Terminate editing string in
                                                  HL
    130    000145 CD....                   call ISTR
    131    000148 E5                       push hl                 ; copy HL
                                                                    into
                                                                    DE
    132    000149 D1                       pop de
    133    00014A CD....                   call parse
    134    00014D 18D3                     jr MAIN
    135    00014F                          
    136    00014F          
    137    00014F          ;---------------------------------------------------
                           -------------------
    138    00014F          ; IM2 Interrupt handler:
    139    00014F F5       I_N_T           PUSH AF
    140    000150 C5                       PUSH BC
    141    000151 D5                       PUSH DE
    142    000152 E5                       PUSH HL
    143    000153 DDE5                     PUSH IX
    144    000155 D9                       EXX
    145    000156 08                       EX AF, AF
    146    000157 F5                       PUSH AF
    147    000158 C5                       PUSH BC
    148    000159 D5                       PUSH DE
    149    00015A E5                       PUSH HL
    150    00015B          
    151    00015B CD....                   CALL PSDII      ; Get value from PS2
                                                            keyboard buffer.
    152    00015E          
    153    00015E E1                       POP HL
    154    00015F D1                       POP DE
    155    000160 C1                       POP BC
    156    000161 F1                       POP AF
    157    000162 D9                       EXX
    158    000163 08                       EX AF, AF
    159    000164 DDE1                     POP IX
    160    000166 E1                       POP HL
    161    000167 D1                       POP DE
    162    000168 C1                       POP BC
    163    000169 F1                       POP AF
    164    00016A FB                       EI
    165    00016B C9                       RET
    166    00016C          
    167    00016C          ;---------------------------------------------------
                           -------------------
    168    00016C          
    169    00016C          #include "nvram.asm"
    170    0001FA          #include "gfx-routines.asm"
    171    000441          #include "maths-routines.asm"
    172    00053B          #include "parser.asm"
    173    0005D0          #include "ps2_handler.asm"
    174    000987          #include "commands/test.asm"
    175    000992          #include "commands/time.asm"
    176    0009CE          #include "commands/date.asm"
    177    000A14          #include "commands/cls.asm"
    178    000A20          #include "commands/reboot.asm"
    179    000A23          #include "booter.asm"
    180    00112A          #include "arrays.asm"
    181    001430          #include "restarts.asm"
    182    000068          
    183    000068          
    184    000068          
    185    000068                  end
##############################
#          CRC:2B0           #
#        Errors:   0         #
#        Warnings: 0         #
#        Bytes: 5040         #
##############################



