###############################################################################
#                                                                             #
#     IAR Systems Z80/64180 Assembler V4.06A/W32 25/Mar/2012  22:23:46        #
#     Copyright 2001 IAR Systems. All rights reserved.                        #
#                                                                             #
#           Target option =  z80                                              #
#           Source file   =  js-os.asm                                        #
#           List file     =  js-os.lst                                        #
#           Object file   =  js-os.r01                                        #
#           Command line  =  js-os.asm -l js-os.lst                           #
#                                                                             #
###############################################################################

      1    005B00          ; ------- external modules
      2    000000          extern    font8
      3    005B00          #include "conf.asm"
      4    005B00          #include "macro.asm"
      5    005B00          #include "vars.asm"
      6    004420          
      7    004420          
      8    004420          ; ------- main code
      9    000000                          rseg CODE
     10    000000          
     11    000000 F3                       di
     12    000001 C3....                   jp START
     13    000004          
     14    000080                          org h'80        ; Decimal 128
     15    000080          START
     16    000080 0611                     ld b,h'11
     17    000082 1605                     ld d, h'5
     18    000084 CD....                   call set_ram_pager
     19    000087 310060                   ld sp, stck
     20    00008A 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
     21    00008C 32015B                   ld (current_pen),a
     22    00008F 110000                   LD DE,h'0000            ; Set XYPOS
                                                                    D - Y , E -
                                                                    X to the
                                                                    default of
                                                                    0,0
     23    000092 ED53035B                 LD (cursor_y),DE
     24    000096 CD....                   call load_font
     25    000099 AF                       xor a
     26    00009A D3FE                     out (254), a
     27    00009C 0612                     ld b,h'12
     28    00009E 1602                     ld d, h'2
     29    0000A0 CD....                   call set_ram_pager
     30    0000A3 CD....                   call LD_64_PAL          ; Load
                                                                    default 64
                                                                    colour
                                                                    palette
     31    0000A6 2103C0                   ld hl, h'c003           ; Hopefully
                                                                    set 360x288
                                                                    text
                                                                    ?
     32    0000A9 CD....                   call set_video_mode
     33    0000AC 0613                     ld b,h'13
     34    0000AE 16F8                     ld d, txpage
     35    0000B0 CD....                   call set_ram_pager
     36    0000B3 CD....                   call cls_text
     37    0000B6 3E00                     ld a, h'0
     38    0000B8 32025B                   ld (border_colour), a
     39    0000BB CD....                   call set_border
     40    0000BE                          
     41    0000BE           ; setup system variable
     42    0000BE          
     43    0000BE 3E01                     ld a, 1
     44    0000C0 32085B                   ld (cursorstatus), a
     45    0000C3 3E64                     ld a, 100
     46    0000C5 32075B                   ld (cursorflashtimer), a
     47    0000C8          
     48    0000C8                          
     49    0000C8 CD....    CALL INIT      ; Initialise PS2 keyboard interface.
     50    0000CB          
     51    0000CB          ;Initialise IM2 interrupts:
     52    0000CB 21....   INTA            LD HL, I_N_T
     53    0000CE 22FF5B                   LD (h'5BFF), HL ; Address for IM2
                                                            mode routine.
     54    0000D1 F3                       DI
     55    0000D2 3E5B                     LD A, h'5B
     56    0000D4 ED47                     LD I, A
     57    0000D6 ED5E                     IM 2
     58    0000D8          
     59    0000D8 C3....                   jp MAIN
     60    0000DB          
     61    0000DB          ;-------------------------------
     62    0000DB          ;PS2 initialization:
     63    0000DB 01F7EF   INIT            LD BC,h'EFF7
     64    0000DE 3E80                     LD A,h'80
     65    0000E0 ED79                     OUT (C),A
     66    0000E2 01F7DF                   LD BC,h'DFF7
     67    0000E5 3EF0                     LD A,h'F0
     68    0000E7 ED79                     OUT (C),A
     69    0000E9 01F7BF                   LD BC,h'BFF7
     70    0000EC 3E02                     LD A,h'02
     71    0000EE ED79                     OUT (C),A
     72    0000F0 C9                       RET
     73    0000F1          ;-------------------------------
     74    0000F1          ; IM2 Interrupt handler:
     75    0000F1 F5       I_N_T           PUSH AF
     76    0000F2 C5                       PUSH BC
     77    0000F3 D5                       PUSH DE
     78    0000F4 E5                       PUSH HL
     79    0000F5 DDE5                     PUSH IX
     80    0000F7 D9                       EXX
     81    0000F8 08                       EX AF, AF
     82    0000F9 F5                       PUSH AF
     83    0000FA C5                       PUSH BC
     84    0000FB D5                       PUSH DE
     85    0000FC E5                       PUSH HL
     86    0000FD          
     87    0000FD CD....                   CALL PSDII      ; Get value from PS2
                                                            keyboard buffer.
     88    000100          
     89    000100 E1                       POP HL
     90    000101 D1                       POP DE
     91    000102 C1                       POP BC
     92    000103 F1                       POP AF
     93    000104 D9                       EXX
     94    000105 08                       EX AF, AF
     95    000106 DDE1                     POP IX
     96    000108 E1                       POP HL
     97    000109 D1                       POP DE
     98    00010A C1                       POP BC
     99    00010B F1                       POP AF
    100    00010C FB                       EI
    101    00010D C9                       RET
    102    00010E                          
    103    00010E          ;MAIN CYCLE:
    104    00010E FB       MAIN            EI   
    105    00010F                          
    106    00010F 3E0C                     ld a,h'0C                       ;
                                                 Set charcol variable to
                                                 default value
    107    000111 32015B                   ld (current_pen),a
    108    000114 110000                   ld de, h'0000           ; Set Y=0 ,
                                                                    X=0
    109    000117 ED53035B                 ld (cursor_y), de
    110    00011B 21....                   ld hl , M_HEAD1
    111    00011E CD....                   call print_msg_c
    112    000121 3E0F                     ld a, h'0f
    113    000123 32015B                   ld (current_pen), a
    114    000126 110001                   ld de, h'0100           ; Set Y=1 ,
                                                                    X=0
    115    000129 ED53035B                 ld (cursor_y), de
    116    00012D 21....                   ld hl , M_HEAD2
    117    000130 CD....                   call print_msg_c
    118    000133          
    119    000133 CD....                   call parse
    120    000136          
    121    000136          
    122    000136          
    123    000136 11000A   MAIN1           ld de, h'0A00           ; Set Y=10 ,
                                                                    X=0
    124    000139 ED53035B                 ld (cursor_y), de
    125    00013D CD....                   CALL CLAVA      ;poll for key
                                                            press
    126    000140 2803                     JR Z, nvramloop ;Z - not pressed, NZ
                                                            - pressed
    127    000142 CD....                   Call os_plotchar
    128    000145                          ;call cursor_flash
    129    000145          nvramloop       
    130    000145          
    131    000145 110005                   ld de, h'0500           ; Set Y=5 ,
                                                                    X=0
    132    000148 ED53035B                 ld (cursor_y), de
    133    00014C 21....                   ld hl , M_TIME
    134    00014F CD....                   call os_print_string
    135    000152 1E04                     ld e, h'04
    136    000154 CD....                   call READ_NVRAM_LOC
    137    000157 3A005D                   ld a, (nv_buf)
    138    00015A CD....                   call BCD_DISP
    139    00015D 3E3A                     ld a, ':'
    140    00015F CD....                   call os_plotchar
    141    000162 1E02                     ld e, h'02
    142    000164 CD....                   call READ_NVRAM_LOC
    143    000167 3A005D                   ld a, (nv_buf)
    144    00016A CD....                   call BCD_DISP
    145    00016D 3E3A                     ld a, ':'
    146    00016F CD....                   call os_plotchar
    147    000172 1E00                     ld e, h'00
    148    000174 CD....                   call READ_NVRAM_LOC
    149    000177 3A005D                   ld a, (nv_buf)
    150    00017A CD....                   call BCD_DISP
    151    00017D C3....                   jp MAIN1
    152    000180                          
    153    000180          
    154    000180          #include "nvram.asm"
    155    00020E          #include "gfx-routines.asm"
    156    00045D          #include "maths-routines.asm"
    157    00054D          #include "parser.asm"
    158    0005C9          #include "ps2_handler.asm"
    159    00097E          #include "commands/test.asm"
    160    000989          #include "commands/time.asm"
    161    0009BF          #include "commands/date.asm"
    162    0009FF          #include "commands/cls.asm"
    163    000A0B          #include "booter.asm"
    164    001112          #include "arrays.asm"
    165    001446          #include "restarts.asm"
    166    000068          
    167    000068          
    168    000068          
    169    000068                  end
##############################
#          CRC:F831          #
#        Errors:   0         #
#        Warnings: 0         #
#        Bytes: 5062         #
##############################



